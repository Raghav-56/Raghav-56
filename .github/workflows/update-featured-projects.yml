name: Update Featured Projects

on:
  schedule:
    - cron: "20 3 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-projects:
    runs-on: ubuntu-latest
    concurrency:
      group: profile-readme-automation
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate featured projects markdown
        id: projects
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          repos=$(curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/users/Raghav-56/repos?per_page=100")
          echo "$repos" | jq -r '
            map(select(.fork == false and .archived == false and .name != "Raghav-56"))
            | sort_by(.pushed_at)
            | reverse
            | .[:4]
            | .[]
            | "- [\(.name)](\(.html_url)) â€” \((.description // "Active repository by Raghav Gupta") | gsub("\\r|\\n"; " "))"
          ' > projects-list.md

          {
            echo "content<<EOF"
            echo "## ðŸŒŸ Featured Projects"
            echo
            cat projects-list.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Replace projects section
        env:
          SECTION_CONTENT: ${{ steps.projects.outputs.content }}
        run: |
          python - <<'PY'
          from pathlib import Path

          path = Path("README.md")
          start = "<!-- PROJECTS_SECTION:START -->"
          end = "<!-- PROJECTS_SECTION:END -->"
          section_content = __import__("os").environ["SECTION_CONTENT"].strip()

          content = path.read_text(encoding="utf-8")
          start_idx = content.find(start)
          end_idx = content.find(end)
          if start_idx == -1 or end_idx == -1:
              raise SystemExit("Project section markers not found")

          end_idx += len(end)
          replacement = f"{start}\n{section_content}\n{end}"
          updated = content[:start_idx] + replacement + content[end_idx:]
          path.write_text(updated, encoding="utf-8")
          PY

      - name: Commit changes
        run: |
          if git diff --quiet README.md; then
            echo "No project updates to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: refresh featured projects"
          git push
